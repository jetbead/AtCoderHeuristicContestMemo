# 局所探索/山登り/焼きなまし

## Links

- 誰でもできる焼きなまし法(gasin さん)
  - https://gasin.hatenadiary.jp/entry/2019/09/03/162613
- 焼きなまし法のコツ Ver. 1.3(shindannin さん)
  - https://shindannin.hatenadiary.com/entry/2021/03/06/115415
- 詳解 焼きなまし法(hakomo さん)
  - https://github.com/hakomo/Simulated-Annealing-Techniques
- 競技プログラミングにおいて焼きなまし法に堕ちずに落とすコツ(tsukammo さん)
  - https://qiita.com/tsukammo/items/b410f3202372fe87c919
- chokudai 先生の焼きなまし講座
  - https://togetter.com/li/607979
- 貪欲法、山登り法、焼きなまし、ビームサーチ、これらの間の関係について(kmyk さん)
  - https://kmyk.github.io/blog/blog/2019/03/07/local-search-and-greedy/
- 焼きなましをするときの設計に関するメモ(yunix_kyopro さん)
  - https://yunix-kyopro.hatenablog.com/entry/2022/10/30/141616
  - https://twitter.com/yunix91201367/status/1586588684622520322


## 有用性

- 「焼きなましが適用できたら強い」ケースが多い
  - 素直に適用できる場合もあれば、工夫が必要だったり、強引に適用できたり、など
  - 探索空間がガタガタだったり大きかったりすると、うまく収束しなかったり、収束までに時間がかかったりして、他の手法よりも悪い場合もある
- 適用できた場合も、状態の持ち方、近傍、評価関数などで、探索空間の形が大きく変わり差が出やすい
  - 同じ場合は、高速化、差分計算などで差がつく
- 「焼きなましを適用できるか？」という視点から入ると視野が狭まりやすいので、さまざまな状態の持ち方や探索の仕方(ルールベース/貪欲法など)を検討して、その改善として「焼きなまし」を考えたほうが良い

## 状態
(自明・非自明というのは、適当に自分の中での分類なので注意)

- 自明系
  - 盤面やグラフなど、問題の解空間をそのまま状態に持つ
  - 訪問点の順番(TSP系)
- 非自明系
  - 問題の解空間の一部だけ状態に持つ(残りは別途最適化)
  - 操作列をそのまま持つ
  - 訪問辺順番(TSP系)
  - 「解空間->状態空間->解空間」みたいな変換(復元)ができる場合、より性質の良い(探索空間の小さい)状態空間で探索する

### 状態の局所性

- 局所性
  - 状態内の離れた2つの要素に関連性(依存関係、文脈)がなければ、それぞれの要素は独立に考えることができる
  - 焼きなましは、「状態を少し変えて改善(局所探索)」という感じのため、近傍を考えるうえで重要
    - 状態の1つの要素を入れ替えるのが容易などであれば、それを近傍として局所探索/山登り/焼きなましができる
    - 2次元グリッドなどの問題の場合、部分的な領域で見るとそこだけを入れ替えて別の状態にできるなら近傍として利用できる

## 近傍

- 同じ焼きなまし解だとしても差がでる大きな要素
  - 近傍によって探索空間の形が変わるため、探索の質に直結する
- 「極小で高速な近傍」「依存する要素をまとめて置き換える近傍」など
- 近傍として望ましい条件にはいくつかありえるが、基本的には、良い状態間を行き来できるような近傍を考えられるか

### 変化量が小さな近傍

- 状態の変化(スコアの変化量)がとても小さい近傍のこと
  - 状態の1要素を他の要素と入れ替える、位置を1だけずらす、2つの要素をswapする、など
- 「一番小さい」と思っても、より変化量が小さい近傍が作れる可能性があるので、できるだけ検討する
  - 2-opt近傍
  - https://phyllo-algo.hatenablog.com/entry/2018/06/21/002545


### 確実に前進する近傍

- https://qiita.com/takapt0226/items/b2f6d1d77a034b529e21#%E9%81%B7%E7%A7%BB


### 2-opt 近傍

- https://en.wikipedia.org/wiki/2-opt
- 巡回セールスマン問題などで、2 点を交換する 2-swap 近傍は 4 辺変化してしまうが、そこを 2 辺変化させるような近傍
- 実装方法にもよるが、訪問点の順を状態に持っている場合は、ある範囲を reverse する感じになる
  - O(N)程度かかる
  - (辺の付替え時に分離しないように付け替える必要があるが、その判定のためにO(N)で辺をたどる必要があるため)
    - https://twitter.com/hotpepsi/status/1509563061027610624
- その他
  - k-opt(3-opt, 4-opt, double-bridge)
  - Lin-Kernighan Heuristic

### kick 近傍

- 局所解を抜け出す(kick)ような状態を大きく変える近傍
- Introduction to Heuristics Contest 解説 p.7
  - https://img.atcoder.jp/intro-heuristics/editorial.pdf
- k-swap-kick
  - TSP などで、k 個のセグメント s1,s2,...,sk を s1,sk,...,s2 にする感じ
- 2-opt ではたどり着くのが難しいような double bridge みたいな形にキックする

### 部分破壊と再構築

- https://togetter.com/li/607979?page=2
- パスやサイクルの一部を破壊してDFSで再構築
  - [AHC002](../ContestMemo/ahc002.md)
  - [AHC010](../ContestMemo/ahc010.md)
- 領域の一部を破壊して再構築
  - [AHC014](../ContestMemo/ahc014.md)
    - 解が操作列でも、盤面での部分領域に対応する部分列の削除＆後ろに操作列追加で近傍を作成可能
    - 操作列に注目しても、操作列の依存関係を有向グラフとしてトポロジカルソートすると操作列の途中から最後をまとめて削除、ということもできる
  - [AHC020](../ContestMemo/ahc020.md)
    - ある放送局の強度を0にして、カバーできなくなった家を適当な順番で最小コストでカバーする近傍
    - ある放送局の強度を上げて、順番にカバーできない家ができないように最小化する近傍
    - など

## 評価関数

- スコアをそのまま利用
- [AHC011](../ContestMemo/ahc011.md)
  - 2タイルをswapする近傍で、「一番大きな木のサイズ」を評価関数にすると、それ以外のタイルの状態が考慮できないので、「連結成分の個数(が1になるようにする)」や「連結成分のサイズの2乗和」などにすると、収束が速い

## 高速化

### 差分計算

- [AHC012](../ContestMemo/ahc012.md)
  - 直線の追加削除は、その直線の両側の領域だけを考えれば良い
  - ある領域にある個数は座圧＋二次元累積和でO(1)で求められ、領域数はO(K)程度

### 状態更新を後に持っていくテク

- [AHC009](../ContestMemo/ahc009.md)
  - 前からDP・後からDPを持っておくと、差分計算が高速に求められる
  - さらに、近傍更新時の変更箇所をターン順方向に固定すると、状態更新の方も高速化可能

### 評価関数計算の打ち切り

- https://qiita.com/not522/items/cd20b87157d15850d31c
  - 変化量からしきい値以下か判定するところを式変形して、遷移先に依存しないところを先に計算しておくことで、評価関数内でしきい値を超えることがわかったタイミングで打ち切れるようになるテク

## その他
### Invalidな状態を許容する焼きなまし

- [AHC011](../ContestMemo/ahc011.md)
  - 最終的に「与えられたタイルで作れる」必要があるが、辺の追加・削除を近傍に、与えられたタイルで作れない状態も探索
    - ただし、評価関数は各利用タイル数の差にして0になるよう目指す

### Successive Halving

- https://cyberagent.ai/blog/research/1036/
